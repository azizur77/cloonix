#!/bin/bash
set -e
HERE=`pwd`
CLOONIX_COMMON=${HERE}/../../../cloonix/common
TARGET=${CLOONIX_COMMON}/spice/spice_lib
if [ ! -d ${TARGET} ]; then
  echo
  echo NOT FOUND:
  echo ${TARGET}
  echo
  exit
fi

cd ${HERE}/spice_client
./patched_create
mv tainted_spice spice_client
rm -rf ${TARGET}/spice_client
mv spice_client ${TARGET}


SPICE_LIB=/usr/local/bin/cloonix/common/spice/spice_lib


PREFIX=/usr/local/bin/cloonix/gtk3
if [ -e ${PREFIX} ]; then
  cd ${TARGET}/spice_client/po
  rm -f Makefile.in.in
  ln -s /usr/local/bin/cloonix/gtk3/share/intltool/Makefile.in.in Makefile.in.in
  cd ${TARGET}/spice_client
  export PATH="${PREFIX}/bin:$PATH"
  export C_INCLUDE_PATH="${PREFIX}/include"
  export CFLAGS="-I${PREFIX}/include"
  export LDFLAGS="-L${PREFIX}/lib"
  export PKG_CONFIG_PATH="${TARGET}/pkgconfig:${PREFIX}/lib/pkgconfig"
  export PKG_CONFIG_LIBDIR=$PKG_CONFIG_PATH
else
  cd ${TARGET}/spice_client
  export PKG_CONFIG_PATH=${TARGET}/pkgconfig 
fi

  ./configure --prefix=${TARGET} \
              --libdir=${TARGET} \
              --datarootdir=${TARGET} \
              --with-usb-acl-helper-dir=${SPICE_LIB} \
              --enable-polkit \
              --enable-usbredir \
              --enable-gtk-doc=no \
              --enable-gtk-doc-html=no \
              --enable-gtk-doc-pdf=no \
              --enable-controler=no \
              --enable-dbus=no \
              --enable-vala=no \
              --enable-webdav=no \
              --enable-smartcard=no \
              --enable-lz4=no


make clean
make
for i in Makefile doc/Makefile data/Makefile man/Makefile src/Makefile src/controller/Makefile; do
  sed -i s"%POLICYDIR = .*%POLICYDIR = ${TARGET}%" $i
  sed -i s"%ACL_HELPER_DIR = .*%ACL_HELPER_DIR = ${TARGET}%" $i
done
make install


